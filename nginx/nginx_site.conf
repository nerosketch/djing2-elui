upstream djing2 {
	server djing2_app:8000;
}


# обработка http запросов.
server {
	listen ${NGINX_PORT};
	server_name _;
	root /var/www/app;
	charset utf-8;
	proxy_read_timeout 950s;

	access_log /dev/null;
	error_log /dev/null;

	#limit_req zone=one burst=50 nodelay;

	index index.html;

	##
	# Basic Settings
	##
	sendfile on;
	aio on;
	tcp_nopush on;
	tcp_nodelay on;
	server_tokens off;
	keepalive_timeout 600;
	types_hash_max_size 2048;

	##
	# Gzip Settings
	##

	gzip on;
	gzip_min_length 100;
	gzip_vary on;
	gzip_proxied any;
	gzip_comp_level 8;
	gzip_buffers 16 8k;
	# gzip_http_version 1.1;
	gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

	client_max_body_size 120M;

	location /media/user/avatar/ {
		alias /var/www/media/user/avatar/;
		expires 15d;
		error_page 404 =200 /img/user_ava_min.gif;
	}

	location /media/ {
		alias /var/www/media/;
		expires 10d;
	}

	location = /bad_browser.html {
		alias /var/www/bad_browser.html;
		expires 30d;
		include /etc/nginx/expires-hdrs.conf;
	}

	location ~ ^/api/devices/pon/\d+/scan_onu_list/$ {
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        #proxy_set_header Upgrade $http_upgrade;
        #proxy_set_header Connection $connection_upgrade;
        proxy_redirect off;
        proxy_buffering off;
        proxy_pass http://djing2$request_uri;
	}

	#location /ws {
	#	proxy_pass http://127.0.0.1:8081/ws;
	#	proxy_http_version 1.1;
	#	proxy_set_header Upgrade $http_upgrade;
	#	proxy_set_header Connection "upgrade";
	#}

	location /api/ {
		#access_log /var/log/nginx/djing2_ssl_access.log;
		#error_log /var/log/nginx/djing2_ssl_error.log;
		error_page 503 =200 @fallback503;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        #proxy_set_header Upgrade $http_upgrade;
        #proxy_set_header Connection $connection_upgrade;
        proxy_redirect off;
        proxy_buffering off;
        proxy_pass http://djing2/api/;
	}

	location / {
		include /etc/nginx/browsersupp.conf;
        include /etc/nginx/root_serve.conf;
	}
}

server {
    listen 443 ssl http2;
    ssl on;
    server_name _;
    root /var/www/app;

    proxy_read_timeout 950s;

    charset      utf-8;

    ssl_certificate "/etc/cert_fullchain.pem";
    ssl_certificate_key "/etc/cert_privkey.pem";
    ssl_trusted_certificate "/etc/cert_chain.pem";
    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout 10m;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    keepalive_timeout 70;

    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 77.88.8.8;

    access_log off;
    error_log off;

    #limit_req zone=one burst=50 nodelay;

    #include /etc/nginx/acme.conf;
    #include /etc/nginx/errors.conf;

    # Error pages
    error_page 403 /403.html;
    location /403.html {
        alias /var/www/app/403.html;
        expires 1d;
    }

    location = /robots.txt { alias /var/www/app/robots.txt; }
    index index.html;
    client_max_body_size 50m;

    location /media/user/avatar/ {
        access_log off;
        error_log off;
        alias /var/www/media/user/avatar/;
        expires 1M;
        include /etc/nginx/expires-hdrs.conf;
        error_page 404 =200 /img/user_ava_min.gif;
    }

    location /media/ {
        alias /var/www/media/;
        expires 1M;
        include /etc/nginx/expires-hdrs.conf;
    }

    #location /static {
    #    alias /var/www/djing2/static;
    #    expires 5d;
    #    include /etc/nginx/expires-hdrs.conf;
    #}

    location = /bad_browser.html {
        alias /var/www/app/bad_browser.html;
        expires 30d;
        include /etc/nginx/expires-hdrs.conf;
    }

    location ~ ^/api/devices/pon/\d+/scan_onu_list/$ {
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
        proxy_buffering off;
        proxy_pass http://djing2$request_uri;
    }

    location /ws {
        proxy_pass http://localhost:8080/ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /api/tasks/active_task_count/ {
        access_log off;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
        proxy_buffering off;
        proxy_pass http://djing2$request_uri;
    }

    location ~ ^/api/fin/alltime/\w+/pay/(?:$|\/) {
        allow 31.40.132.30;
        allow 2.63.189.236;
        allow 91.219.235.70;
        allow 80.245.114.191;
        allow 10.12.2.2;
        deny all;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
        proxy_buffering off;
        proxy_pass http://djing2$request_uri;
        #access_log /var/log/nginx/djing2_ssl_access.log;
        #error_log /var/log/nginx/djing2_ssl_error.log;
    }

    location /api/fin/rncb/default/pay/ {
        allow 195.200.209.0/24;
        #allow 10.12.0.0/16;
        deny all;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
        proxy_buffering off;
        proxy_pass http://djing2$request_uri;
        #access_log /var/log/nginx/djing2_ssl_access.log;
        #error_log /var/log/nginx/djing2_ssl_error.log;
    }

    #location /docs {
    #    auth_basic "Restricted dir";
    #    auth_basic_user_file /etc/nginx/htpasswd.users;
    #    proxy_set_header Host $http_host;
    #    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #    proxy_set_header X-Forwarded-Proto $scheme;
    #    proxy_pass http://djing2$request_uri;
    #}

    location /api {
        error_page 503 =200 @fallback503;
        #access_log /var/log/nginx/djing2_ssl_access.log;
        #error_log /var/log/nginx/djing2_ssl_error.log;
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
        proxy_buffering off;
        proxy_pass http://djing2$request_uri;
    }

    #include /etc/nginx/sites-available/djing2_cams.conf;

    location / {
        include /etc/nginx/browsersupp.conf;
        try_files $uri $uri/ /index.html;
    }
}

